<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>commentree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f9f9f9; font-family: 'Helvetica Neue', Arial, sans-serif; }
        
        header { 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            z-index: 10; 
            pointer-events: none; 
            display: flex;
            flex-direction: column; 
            gap: 2px; 
            align-items: flex-start;
            max-width: 96%; 
            max-height: 90vh;
        }
        
        h1 { 
            margin: 0; 
            font-size: 1.6rem; 
            color: #000; 
            pointer-events: auto; 
            letter-spacing: -0.5px;
            line-height: 1.1; 
            white-space: nowrap;       
            overflow: hidden;          
            text-overflow: ellipsis;   
            width: 100%;               
            display: block;            
        }
        
        h1 a {
            color: #0095f6; 
            text-decoration: none;
            cursor: pointer;
        }
        h1 a:hover { text-decoration: underline; }

        .welcome-text {
            margin: 0 0 5px 0; 
            font-size: 0.85rem; 
            color: #555;
            line-height: 1.3; 
            width: 100%;
            max-width: 100%; 
            pointer-events: auto;
            letter-spacing: -0.5px; 
            word-break: normal;
            padding: 0 2px;
        }

        .instruction-text {
            font-size: 0.85rem;
            color: #888;
            margin-top: 2px; 
            display: block; 
        }

        .nav-container {
            display: flex;
            flex-direction: column;
            gap: 3px; 
            pointer-events: auto;
            max-width: 100%;
        }

        .nav-label {
            margin: 0;
            font-size: 0.9rem;
            color: #444;
            font-weight: bold;
            padding-left: 2px; 
        }

        .nav-box {
            background: rgba(255, 255, 255, 0.85); 
            padding: 4px 12px 2px 12px; 
            border-radius: 12px; 
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column; 
            width: fit-content;
            min-width: 280px; 
            max-width: 100%; 
            box-sizing: border-box; 
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            font-size: 1rem;
            color: #333;
            width: 100%;
            justify-content: space-between;
            padding: 2px 0; 
            line-height: 1.2;
        }

        .domain-text {
            font-weight: bold;
            color: #888;
            margin-right: 2px;
            font-size: 0.95rem;
            white-space: nowrap; 
            line-height: 1; 
        }

        #navInput {
            border: none;
            border-bottom: 2px solid #ccc; 
            background: transparent;
            font-size: 1rem;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: #000;
            width: 100%; 
            padding: 0 5px; 
            height: 100%; 
            outline: none;
            transition: border-color 0.3s;
        }
        
        #navInput::placeholder { 
            color: #bbb; 
            font-size: 0.9rem;
        }
        #navInput:focus { border-bottom: 2px solid #0095f6; }

        #goBtn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #0095f6;
            padding: 0 5px;
            transition: transform 0.2s;
            flex-shrink: 0; 
            line-height: 1;
        }
        #goBtn:hover { transform: translateX(3px); }

        .nav-divider {
            height: 1px;
            background-color: #eee;
            margin: 2px 0; 
            width: 100%;
        }

        .recommend-section-inline {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #888;
            width: 100%;
            gap: 6px; 
            padding: 2px 0; 
        }

        .recommend-label {
             font-weight: bold;
             white-space: nowrap; 
        }

        .recommend-handle-container {
            flex-grow: 1; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
            min-width: 0; 
        }

        .recommend-handle-container a {
            text-decoration: none;
            color: #555;
            transition: color 0.2s;
            display: block; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recommend-handle-container a:hover {
            color: #0095f6;
            text-decoration: underline;
        }
        .handle-highlight {
            color: #0095f6;
            font-weight: 500;
        }

        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #0095f6;
            padding: 0;
            line-height: 1;
            flex-shrink: 0; 
        }
        .refresh-btn:hover { transform: rotate(90deg); transition: transform 0.3s; }


        @media (max-width: 600px) {
            header { 
                left: 50%; 
                transform: translateX(-50%); 
                top: 15px; 
                width: 96%; 
                align-items: center; 
                text-align: center;
            }
            h1 { font-size: 1.4rem; }
            
            .nav-container {
                align-items: center;
            }
            
            .nav-label {
                padding-left: 0;
            }

            .nav-box {
                min-width: auto;
                width: 98%; 
            }
        }

        #inputModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 85%; max-width: 320px; }
        input[type="text"] { width: 90%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; } 
        button.modal-btn { padding: 10px 25px; background: #000; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 1rem;}
        button.modal-btn:hover { background: #333; }

        .bubble-text {
            display: flex; justify-content: center; align-items: center; text-align: center;
            width: 100%; height: 100%; white-space: normal;
            word-wrap: break-word; word-break: break-word; line-height: 1.2; overflow: hidden; padding: 2px; box-sizing: border-box;
        }
    </style>
</head>
<body>
    <header>
        <h1>commentree.net/<a id="headerHandleLink" href="#" target="_blank"></a></h1>
        
        <p class="welcome-text">
            Speak free on Commentree.<br>
            Anyone can leave a comment on any Instagram handle.
            <span class="instruction-text">Click on nodes to leave a comment.</span>
        </p>
        
        <div class="nav-container">
            <p class="nav-label">Visit another account?</p>
            
            <div class="nav-box">
                <div class="input-wrapper">
                    <span class="domain-text">commentree.net/</span>
                    <input type="text" id="navInput" placeholder="Enter handle" autocomplete="off">
                    <button id="goBtn" onclick="navigateToHandle()">→</button>
                </div>

                <div class="nav-divider"></div>

                <div class="recommend-section-inline">
                    <span class="recommend-label">Random visit:</span>
                    <div id="recommendListInline" class="recommend-handle-container">
                        Loading...
                    </div>
                    <button class="refresh-btn inline-refresh" onclick="refreshList()" title="Refresh">↻</button>
                </div>
            </div>
        </div>
    </header>

    <div id="chart"></div>

    <div id="inputModal">
        <div class="modal-content">
            <h3>Leave a comment</h3>
            <input type="text" id="commentInput" placeholder="Enter your comment" maxlength="50">
            <br>
            <button class="modal-btn" onclick="submitComment()">Submit</button>
            <button class="modal-btn" onclick="closeModal()" style="background:#999">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD03P2MQJUUwTpkc2B6EGTrttPtb0JKbxU",
            authDomain: "commentree-87c10.firebaseapp.com",
            projectId: "commentree-87c10",
            storageBucket: "commentree-87c10.firebasestorage.app",
            messagingSenderId: "174582656984",
            appId: "1:174582656984:web:e877e8161686731c878cad",
            measurementId: "G-9F4JTS1DV0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let handle = window.location.pathname.replace("/", "").toLowerCase(); 
        if (!handle) {
            handle = "@realdonaldtrump";
            window.history.replaceState(null, "", "/" + handle);
        }

        handle = decodeURIComponent(handle);
        if (!handle.startsWith("@")) handle = "@" + handle;
        const cleanHandle = handle.replace("@", ""); 

        const headerLink = document.getElementById("headerHandleLink");
        headerLink.innerText = handle;
        headerLink.href = `https://www.instagram.com/${cleanHandle}/`;

        const navInput = document.getElementById("navInput");
        
        window.navigateToHandle = function() {
            let val = navInput.value.trim();
            if(!val) return;
            if(!val.startsWith('@')) val = '@' + val;
            window.location.href = "/" + val.toLowerCase();
        }

        navInput.addEventListener("keyup", function(event) {
            if (event.key === "Enter") window.navigateToHandle();
        });

        // --- 추천 리스트 로직 ---
        let allHandles = [];

        async function fetchAllHandles() {
            try {
                const querySnapshot = await getDocs(collection(db, "trees"));
                allHandles = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== handle) {
                        allHandles.push(doc.id);
                    }
                });
                window.refreshList();
            } catch (e) {
                console.error("Error fetching handles:", e);
                document.getElementById("recommendListInline").innerHTML = "No data";
            }
        }

        window.refreshList = function() {
            const listEl = document.getElementById("recommendListInline");
            listEl.innerHTML = "";

            if (allHandles.length === 0) {
                listEl.innerHTML = "No others yet";
                return;
            }

            const shuffled = [...allHandles].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 1); 

            selected.forEach((h) => {
                let displayHandle = h.startsWith('@') ? h : '@' + h;
                const linkHTML = `<a href="/${h}" title="commentree.net/${displayHandle}">commentree.net/<span class="handle-highlight">${displayHandle}</span></a>`;
                listEl.innerHTML = linkHTML;
            });
        }

        fetchAllHandles();
        // ---------------------------------

        window.dataset = { nodes: [], links: [] };
        let selectedNode = null;
        let docRef = doc(db, "trees", handle); 
        
        let width = window.innerWidth;
        let height = window.innerHeight;

        function getRootLabel() {
            return `What do you think of her/him?`;
        }

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const nodes = data.nodes.map(d => ({...d}));
                window.dataset = {
                    nodes: nodes,
                    links: data.links.map(d => ({...d}))
                };
            } else {
                const initialData = {
                    nodes: [{ 
                        id: "root", 
                        label: getRootLabel(), 
                        color: "#000000", 
                        radius: 70, 
                        x: width / 2, 
                        y: height / 2, 
                        phase: Math.random() * Math.PI * 2 
                    }],
                    links: []
                };
                setDoc(docRef, initialData); 
                window.dataset = initialData;
            }
            restartSimulation(); 
        });

        const svg = d3.select("#chart").append("svg")
            .attr("width", width).attr("height", height);

        const zoom = d3.zoom().on("zoom", (event) => g.attr("transform", event.transform));
        
        svg.call(zoom)
           .on("dblclick.zoom", null); 

        const g = svg.append("g");
        const linkLayer = g.append("g").attr("class", "links");
        const nodeLayer = g.append("g").attr("class", "nodes");

        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id)) 
            .force("charge", d3.forceManyBody()) 
            .force("collide", d3.forceCollide().radius(d => d.radius + 10).iterations(3));

        function restartSimulation() {
            width = window.innerWidth;
            height = window.innerHeight;
            const isMobile = width < 600;

            simulation.force("center", d3.forceCenter(width / 2, height / 2));
            simulation.force("link").distance(isMobile ? 55 : 110);
            simulation.force("charge").strength(isMobile ? -250 : -450);

            simulation.nodes(window.dataset.nodes);
            simulation.force("link").links(window.dataset.links);
            update();
            simulation.alpha(1).restart();

            setTimeout(zoomToFit, 300);
        }

        function zoomToFit() {
            const nodes = window.dataset.nodes;
            if (!nodes || nodes.length === 0) return;

            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            nodes.forEach(d => {
                if (d.x === undefined || d.y === undefined) return;
                minX = Math.min(minX, d.x - d.radius);
                maxX = Math.max(maxX, d.x + d.radius);
                minY = Math.min(minY, d.y - d.radius);
                maxY = Math.max(maxY, d.y + d.radius);
            });

            if (minX === Infinity) return; 

            const padding = 60; 
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            const midX = (minX + maxX) / 2;
            const midY = (minY + maxY) / 2;

            if (contentWidth === 0 || contentHeight === 0) return;

            const scale = 0.85 / Math.max(contentWidth / width, contentHeight / height);
            
            svg.transition()
                .duration(1200) 
                .call(
                    zoom.transform,
                    d3.zoomIdentity
                        .translate(width / 2 - scale * midX, height / 2 - scale * midY)
                        .scale(scale)
                );
        }

        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            d3.select("svg").attr("width", width).attr("height", height);
            simulation.force("center", d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        });

        function update() {
            const link = linkLayer.selectAll(".link")
                .data(window.dataset.links)
                .join("line")
                .attr("class", "link")
                .attr("stroke", "#bbb").attr("stroke-width", 2);

            const node = nodeLayer.selectAll(".node")
                .data(window.dataset.nodes, d => d.id)
                .join("g")
                .attr("class", "node")
                .call(drag(simulation));

            node.selectAll("circle").remove();
            node.append("circle")
                .attr("r", d => d.radius)
                .attr("fill", d => d.color) 
                .attr("stroke", "#000").attr("stroke-width", 2)
                .style("cursor", "pointer")
                .style("filter", "drop-shadow(0px 3px 3px rgba(0,0,0,0.1))")
                .on("click", (event, d) => {
                    event.stopPropagation();
                    openModal(d);
                });

            node.selectAll("foreignObject").remove();
            node.append("foreignObject")
                .attr("width", d => d.radius * 1.45) 
                .attr("height", d => d.radius * 1.45)
                .attr("x", d => -d.radius * 0.725).attr("y", d => -d.radius * 0.725)
                .style("pointer-events", "none") 
                .append("xhtml:div")
                .attr("class", "bubble-text")
                .style("color", d => d.color === "#000000" ? "#fff" : "#000")
                .style("font-weight", "bold")
                .style("font-size", d => {
                    const len = d.label.length;
                    let divider = 3.5; 
                    if (len < 8) divider = 2.5;       
                    else if (len < 15) divider = 3.2; 
                    else if (len < 25) divider = 4.0; 
                    else divider = 5.0;               
                    return Math.max(10, d.radius / divider) + "px";
                })
                .html(d => d.label);

            simulation.on("tick", () => {
                const time = Date.now() / 1000; 
                node.attr("transform", d => {
                    if(!d.x) d.x = width/2; 
                    if(!d.y) d.y = height/2;
                    const floatingY = Math.sin(time * 2 + (d.phase||0)) * 3; 
                    d.displayY = d.y + floatingY; 
                    return `translate(${d.x}, ${d.displayY})`;
                });
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.displayY || d.source.y) 
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.displayY || d.target.y);
            });
        }

        window.openModal = function(node) {
            selectedNode = node;
            document.getElementById("inputModal").style.display = "flex";
            document.getElementById("commentInput").focus();
        }

        window.closeModal = function() {
            document.getElementById("inputModal").style.display = "none";
            document.getElementById("commentInput").value = "";
            selectedNode = null;
        }

        window.submitComment = async function() {
            const text = document.getElementById("commentInput").value;
            if (!text) return alert("Please enter a comment.");

            const newId = "node-" + Date.now();
            
            const newNode = {
                id: newId,
                label: text,
                color: "#ffffff",
                radius: 50, 
                x: selectedNode.x + (Math.random() - 0.5) * 50,
                y: selectedNode.y + (Math.random() - 0.5) * 50,
                phase: Math.random() * Math.PI * 2
            };

            const newLink = { source: selectedNode.id, target: newId };

            window.dataset.nodes.push(newNode);
            window.dataset.links.push(newLink);
            
            const parentNode = window.dataset.nodes.find(n => n.id === selectedNode.id);
            if (parentNode && parentNode.radius < 200) {
                parentNode.radius += 8;
            }

            window.closeModal();

            const saveNodes = window.dataset.nodes.map(n => {
                return {
                    id: n.id, label: n.label, color: n.color, radius: n.radius,
                    x: n.x, y: n.y, phase: n.phase
                };
            });
            
            const saveLinks = window.dataset.links.map(l => {
                return { 
                    source: (typeof l.source === 'object') ? l.source.id : l.source,
                    target: (typeof l.target === 'object') ? l.target.id : l.target
                };
            });

            await updateDoc(docRef, {
                nodes: saveNodes,
                links: saveLinks
            });
        }

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

        document.getElementById("commentInput").addEventListener("keyup", function(event) {
            if (event.key === "Enter") window.submitComment();
        });
    </script>
</body>
</html>